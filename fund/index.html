---
---
<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width,initial-scale=1">
    <link rel=icon href=/assets/favicon.ico>
    <link rel="stylesheet" type="text/css" href="../css/style.css"/>
    <link rel="stylesheet" type="text/css" href="./fund.css"/>

    <script src="https://js.braintreegateway.com/web/dropin/1.32.1/js/dropin.min.js"></script>

    <title>Fund | Brains@Play</title>
</head>
<body>
<!-- <div id=app> -->
    <!--Navbar-->
    {% include nav.html %}

    <div id="fund-header" class="header new">
        <h2>Fund</h2>
    </div>

    <!--Content-->
<section id="futures">
    <div id="fund-info">
        <span id="fund-total"><span id="fund-total-current">$0</span> USD / month</span>
        <p id="fund-latest-contributor" style="opacity: 0; transition: 0.5s;"><small><span id="fund-latest-contributor-name"></span> <span id="fund-latest-contributor-action"></span>!</small></p>
    </div>

    <h2>About the Fund</h2>
    <hr>
    <p><small>
        All the funds raised here are helping to support Brains@Play software development 
        and allow us to focus our efforts wholeheartedly towards releasing open-source biomedical 
        infrastructure.
    </small></p>

    {% include projects.html %}

    <p><small>
        As we scale our efforts, every <strong>$3000 USD</strong> of funding will support another full-time contributor to our projects.
    </small></p>

    <!-- {% include feed.html %} -->

    <p><small>
        Let's do this, together.
    </small></p>

    <small style="opacity: 0.5;">
        â€” Garrett, Josh, and Jacob
    </small>

    <div id="contribution-header">
        <h2>Select a Contribution</h2>
    </div>
    <hr>
    <div class="form-container">
        <div class="form-context">
            <div class='flex'>
                <form  id="contributor-info-form" class="form" action="">
                    <div class="login-element">
                        <input type="text" name="displayName" autocomplete="off" placeholder="Display Name"/>
                    </div>
                    <div class="login-element">
                        <input type="text" name="contributionNote" autocomplete="off" placeholder="Contribution Note"/>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="fund-contribution-amounts">
        <div data-amount="5">
            <p>$5 USD</p>
        </div>
        <div data-amount="10">
            <p>$10 USD</p>
        </div>
        <div data-amount="20">
            <p>$20 USD</p>
        </div>
        <div data-amount="50">
            <p>$50 USD</p>
        </div>
        <div data-amount="250">
            <p>$250 USD</p>
        </div>
        <div data-amount="1000">
            <p>$1000 USD</p>
        </div>
        <div data-amount="5000">
            <p>$5000 USD</p>
        </div>
        <div id="custom">
            <p>$<input id="custom-contribution-amount" type="number"></input> USD</p>
        </div>
    </div>

    <br>

    <div id="dropin-container"></div>
    <br>

    <div id="checkout-container">
        <button id="submit-button">
            <div>
                <span>Fund!</span>
                <br/>
                <span class="small">Secured by Braintree</span>
            </div>
        </button>
        <div>
            <label class="switch">
                <input type="checkbox" checked>
                <span class="slider round"></span>
            </label>
            <small id="contribution-type">Monthly</small>
        </div>
    </div>
    
    <div class="notification">
        <h4 id="error-action"></h4>
        <p><strong><span id="error-name"></span>:</strong> <span id="error-response"></span></p>
    </div>

</section>

    <!--Footer-->
    {% include footer.html %}

<!-- </div> -->

</body>

<script src="./payment.js" type="text/javascript"></script>
<script>

let selectedContribution
let recurring = true
let amounts = document.getElementById('fund-contribution-amounts')
let divs = amounts.querySelectorAll('div')
let custom = document.getElementById('custom')
let customInput = document.getElementById('custom-contribution-amount')
const fundTotal = document.getElementById('fund-total-current')
const latestContributor = document.getElementById('fund-latest-contributor')
const displayName = document.getElementById('fund-latest-contributor-name')
const actionReadout = document.getElementById('fund-latest-contributor-action')

// Show Fund Total
let total = 0
let decoder = new TextDecoder();

fetch(`${SERVER_URI}/fund/contributions`,{
    method: 'GET',
    mode: 'cors',
}).then(async res => {

    // Recieve Contribution Information as a Readable Stream (organized by latest)
    let chunkCount = 0
    const reader = res.body.getReader();

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        let chunk = decoder.decode(value)
        chunk.split('}').forEach(json => {
            try {
                const dict = JSON.parse(`${json}}`)
                total += dict.amount
                fundTotal.innerHTML = `$${total}`

                if (dict.order === 0){
                    latestContributor.style.opacity = 1
                    displayName.innerHTML = dict.displayname || 'anonymous'
                    actionReadout.innerHTML = `contributed $${dict.amount} USD`
                }
            } catch {}
            chunkCount++
        })
    }

}).catch(e => {
    console.error(e)
})

// Handle Custom Amount Input
customInput.oninput = (e) => {
    custom.setAttribute('data-amount', customInput.value)
    selectedContribution = Number.parseFloat(customInput.value)
}

for (let div of divs) {
    div.onclick = () => {
        for (let d of divs) d.classList.remove('selected')
        div.classList.add('selected')

        selectedContribution = Number.parseFloat(div.getAttribute('data-amount'))
    }
}

// Show / Hide Fund Rewards

let monthly = document.getElementById('fund-contribution-monthly') 
let checkbox = document.body.querySelector('input[type="checkbox"]')
let rewards = document.getElementById('fund-rewards')
let type = document.getElementById('contribution-type')

let checkRewards = () => {

    recurring = checkbox.checked
    if (recurring) {
        if (type) type.innerHTML = 'Monthly'
        if (rewards) rewards.innerHTML = 'Coming soon...'
    } else {
        if (type) type.innerHTML = 'One Time'
        if (rewards) rewards.innerHTML = 'None'
    }

}
 
checkbox.onchange = checkRewards
checkRewards()

</script>
</html>
